import{_ as l}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as e,b as h,a as t,e as a,d as n,r as p,o as k}from"./app-CZifbq50.js";const r="/img/docs/proxmox-grafana-influxdb.png",d="/img/docs/proxmox-grafana-panels.png",g={};function o(c,s){const i=p("Badge");return k(),e("div",null,[s[3]||(s[3]=h('<p><strong>Архитектура решения</strong>:</p><ul><li><strong>InfluxDB</strong> для хранения данных</li><li><strong>Telegraf</strong> как агент сбора метрик</li><li><strong>Grafana</strong> для визуализации и анализа</li></ul><h2 id="установка-influxdb" tabindex="-1"><a class="header-anchor" href="#установка-influxdb"><span>Установка InfluxDB</span></a></h2><p>Создаем контейнер и ставим туда InfluxDB</p>',4)),t("ul",null,[t("li",null,[a(i,{text:"CPU",type:"info",vertical:"middle"}),s[0]||(s[0]=n()),a(i,{text:"1vCPU",type:"tip",vertical:"middle"})]),t("li",null,[a(i,{text:"RAM",type:"info",vertical:"middle"}),s[1]||(s[1]=n()),a(i,{text:"2GB",type:"tip",vertical:"middle"})]),t("li",null,[a(i,{text:"HDD",type:"info",vertical:"middle"}),s[2]||(s[2]=n()),a(i,{text:"10GB",type:"tip",vertical:"middle"})])]),s[4]||(s[4]=h(`<p>Устанавливаем необходимые пакеты:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> curl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> wget</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> gnupg</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> software-properties-common</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt-transport-https</span></span></code></pre></div><p>Добавляем репозиторий:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wget</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -qO-</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://repos.influxdata.com/influxdb.key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gpg</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --dearmor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tee</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/apt/trusted.gpg.d/influxdb.gpg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/dev/null</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">export</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> DISTRIB_ID</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lsb_release</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -si</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">); </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">export</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> DISTRIB_CODENAME</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lsb_release</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -sc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;deb [signed-by=/etc/apt/trusted.gpg.d/influxdb.gpg] https://repos.influxdata.com/</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">\${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">DISTRIB_ID</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">,,</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;"> \${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">DISTRIB_CODENAME</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> stable&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tee</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/apt/sources.list.d/influxdb.list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/dev/null</span></span></code></pre></div><p>Сразу после включения репозитория установим пакеты Influxdb:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &amp;&amp; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> influxdb2</span></span></code></pre></div><p>Запустим службу и проверим статус:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">service</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> influxdb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> start</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">service</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> influxdb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> status</span></span></code></pre></div><p>Настроим InfluxDB через пользовательский интерфейс:</p><ol><li>Для этого посетим localhost:8086</li><li>Нажмем «Начать»</li></ol><p>Настроим своего первого пользователя:</p><ol><li>Введите имя пользователя для вашего основного пользователя</li><li>Введите пароль и подтвердите пароль для вашего пользователя</li><li>Введите исходное название организации</li><li>Введите исходное имя корзины</li><li>Нажмите Продолжить</li></ol><p>Теперь InfluxDB инициализируется с помощью основного пользователя, организации и корзины.</p><div class="hint-container important"><p class="hint-container-title">Создайте токен API на чтение и запись данных в корзину, позже добавьте его в <code>telegraf.conf</code></p></div><h2 id="перенаправление-метрик-proxmox" tabindex="-1"><a class="header-anchor" href="#перенаправление-метрик-proxmox"><span>Перенаправление метрик Proxmox</span></a></h2><p>Перенаправим сбор метрик Proxmox на локальный сокет, который может использовать Telegraf.</p><p>Отредактируем файл настроек:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/pve/status.cfg</span></span></code></pre></div><p>Заменим его следующими строками:</p><div class="language-" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>influxdb: monitoring</span></span>
<span class="line"><span>    server 127.0.0.1</span></span>
<span class="line"><span>    port 8089</span></span></code></pre></div><p>или через web интерфейс можно это настроить:<br><em>Центр обработки данных → Сервер метрик → Добавить → InfluxDB</em></p><p>Используя эти настройки, Proxmox будет отправлять метрики внутренне на порт 8089 на локальном хосте, к которому мы подключимся из Telegraf на следующем шаге.</p><h2 id="установка-telegraf" tabindex="-1"><a class="header-anchor" href="#установка-telegraf"><span>Установка Telegraf</span></a></h2><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wget</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -q</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://repos.influxdata.com/influxdata-archive_compat.key</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;393e8779c89ac8d958f81f942f9ad7fb82a25e133faddaf92e15b16e6ac9ce4c influxdata-archive_compat.key&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sha256sum</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &amp;&amp; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> influxdata-archive_compat.key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gpg</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --dearmor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tee</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/dev/null</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;deb [signed-by=/etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg] https://repos.influxdata.com/debian stable main&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tee</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/apt/sources.list.d/influxdata.list</span></span></code></pre></div><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &amp;&amp; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> telegraf</span></span></code></pre></div><h2 id="настроим-плагины-telegraf" tabindex="-1"><a class="header-anchor" href="#настроим-плагины-telegraf"><span>Настроим плагины Telegraf</span></a></h2><p>Сделаем резервную копию и создадим новый, пустой telegraf.conf</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/telegraf/telegraf.conf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/telegraf/telegraf.conf.bak</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/telegraf/telegraf.conf</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/telegraf/telegraf.conf</span></span></code></pre></div><p>Используйте следующие параметры конфигурации в качестве шаблона:</p><div class="hint-container important"><p class="hint-container-title">Не забудьте поменять значения на свои</p></div><div class="code-block-with-title"><div class="code-block-title-bar" data-title="telegraf.conf"><span>telegraf.conf</span></div><div class="language-bash has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="bash" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[agent]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    interval</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;10s&quot;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    round_interval</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    metric_batch_size</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    metric_buffer_limit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    collection_jitter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;0s&quot;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    flush_interval</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;10s&quot;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    flush_jitter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;0s&quot;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    precision</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    hostname</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    omit_hostname</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Configuration for sending metrics to InfluxDB</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[[outputs.influxdb_v2]]</span></span>
<span class="line highlighted"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    urls</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;http://192.168.1.15:8086&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line highlighted"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    token</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;influxdb token&quot;</span></span>
<span class="line highlighted"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    organization</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KLIMOV.su&quot;</span></span>
<span class="line highlighted"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    bucket</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;pve&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Gather metrics from proxmox based on what is in /etc/pve/setup.cfg</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[[inputs.socket_listener]]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    service_address</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;udp://:8089&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[[inputs.smart]]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    ## Optionally specify the path to the smartctl executable</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    path_smartctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;/usr/sbin/smartctl&quot;</span></span>
<span class="line highlighted"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # path_nvme = &quot;/usr/sbin/nvme&quot;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    use_sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    attributes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    devices</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [</span></span>
<span class="line highlighted"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        &quot;/dev/sda --all&quot;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">,</span></span>
<span class="line highlighted"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        &quot;/dev/sdb --all&quot;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[[inputs.sensors]]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    ## Remove numbers from field names.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    ## If true, a field name like &#39;temp1_input&#39; will be changed to &#39;temp_input&#39;.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # remove_numbers = true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    ## Timeout is the maximum amount of time that the sensors command can run.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # timeout = &quot;5s&quot;</span></span></code></pre><div class="collapsed-lines"></div></div></div><p>Если у вас есть nvme устройства, установите <code>nvme-cli</code> и раскомментируйте строку <code>path_nvme = &quot;/usr/sbin/nvme&quot;</code> ну и конечно добавьте свои nvme диски в список для мониторинга:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nvme-cli</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nvme</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> list</span></span></code></pre></div><p>Чтобы разрешить пользователю Telegraf доступ <code>smartctl</code>, нам нужно установить <code>sudo</code> и добавить запись в <code>visudo</code> файл:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> visudo</span></span></code></pre></div><p>Добавить:</p><div class="language-" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># Cmnd alias specification</span></span>
<span class="line"><span>Cmnd_Alias SMARTCTL = /usr/sbin/smartctl</span></span>
<span class="line"><span>telegraf  ALL=(ALL) NOPASSWD: SMARTCTL</span></span>
<span class="line"><span>Defaults!SMARTCTL !logfile, !syslog, !pam_session</span></span></code></pre></div><p>Используйте <code>smartctl</code>, чтобы проверить устройства:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">smartctl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --scan</span></span></code></pre></div><p>И внесите диски в файл <code>telegraf.conf</code> в раздел <code>[[inputs.smart]]</code></p><h3 id="чтобы-контролировать-датчики-вам-нужны-lm-сенсоры" tabindex="-1"><a class="header-anchor" href="#чтобы-контролировать-датчики-вам-нужны-lm-сенсоры"><span>Чтобы контролировать датчики, вам нужны lm-сенсоры</span></a></h3><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lm-sensors</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> watch</span></span></code></pre></div><p>Запустить, чтобы обнаружить возможные датчики:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sensors-detect</span></span></code></pre></div><p>Проверить датчики с помощью:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">watch</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sensors</span></span></code></pre></div><h3 id="протестируите-конфигурацию-telegraf-с-помощью-следующих-команд" tabindex="-1"><a class="header-anchor" href="#протестируите-конфигурацию-telegraf-с-помощью-следующих-команд"><span>Протестируйте конфигурацию Telegraf с помощью следующих команд</span></a></h3><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">telegraf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --debug</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> telegraf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> telegraf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --config</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/telegraf/telegraf.conf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  --test</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smart</span></span></code></pre></div><p>Возможно будут ошибки, <strong>желательно перезагрузить Proxmox</strong></p><p>Просмотр ошибок:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tail</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --follow</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /var/log/syslog</span></span></code></pre></div><p>Если вы позже измените <code>telegraf.conf</code>, перезагрузите Telegraf, чтобы изменения вступили в силу:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reload</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> telegraf</span></span></code></pre></div><h2 id="установка-grafana" tabindex="-1"><a class="header-anchor" href="#установка-grafana"><span>Установка Grafana</span></a></h2><p>Ставил в тот же контейнер что и InfluxDB</p><p>Добавляем репозиторий:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wget</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -q</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -O</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://packages.grafana.com/gpg.key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt-key</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> -</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;deb https://packages.grafana.com/oss/deb stable main&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tee</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -a</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/apt/sources.list.d/grafana.list</span></span></code></pre></div><p>Устанавливаем:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &amp;&amp; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> grafana</span></span></code></pre></div><p>Настройки Grafana:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/grafana/grafana.ini</span></span></code></pre></div><p>Внесите изменения в конфигурацию <code>systemd</code>, запустив <code>daemon-reload</code>, выполнив команду <code>enable</code>:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enable</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> grafana-server</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> start</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> grafana-server</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> grafana-server</span></span></code></pre></div><h3 id="доступ-к-grafana" tabindex="-1"><a class="header-anchor" href="#доступ-к-grafana"><span>Доступ к Grafana</span></a></h3><p>Сразу после запуска службы Grafana получите доступ к URL-адресу из любого вашего любимого веб-браузера. Порт Grafana по умолчанию — <code>3000</code>. Имя пользователя и пароль по умолчанию <code>admin</code> и <code>admin</code> Если вы заходите в панель управления впервые, вам будет предложено изменить пароль.</p><h3 id="добавление-источника-данных-для-мониторинга-proxmox" tabindex="-1"><a class="header-anchor" href="#добавление-источника-данных-для-мониторинга-proxmox"><span>Добавление источника данных для мониторинга Proxmox</span></a></h3><p>Поскольку мы установили и настроили использование InfluxDB для Proxmox, теперь нам нужно добавить источник данных с информацией о базе данных InfluxDB.</p><p>Перейдите к настройкам (значок шестеренки) → выберите Источники данных.<br> Щелкните Добавить источник данных → Выберите InfluxDB, щелкнув по нему</p><p><strong>Добавьте информацию о сервере influxdb</strong>:</p><figure><img src="`+r+'" alt="Добавьте информацию о сервере influxdb" tabindex="0" loading="lazy"><figcaption>Добавьте информацию о сервере influxdb</figcaption></figure><p>Источник данных успешно добавлен для начала мониторинга Proxmox. Теперь мы можем видеть добавленный источник данных в списке.</p><h3 id="импорт-готовых-информационных-панелеи" tabindex="-1"><a class="header-anchor" href="#импорт-готовых-информационных-панелеи"><span>Импорт готовых информационных панелей</span></a></h3><p>Нам нужна эта <code>15356</code>:</p><p><a href="https://grafana.com/grafana/dashboards/15356" target="_blank" rel="noopener noreferrer">Панель мониторинга Proxmox</a></p><p>Для мониторинга датчиков и smart нужно добавить дополнительные блоки в панель.</p><p>Пример:</p><figure><img src="'+d+`" alt="Мониторинг температуры" tabindex="0" loading="lazy"><figcaption>Мониторинг температуры</figcaption></figure><p>Пример запроса мониторинга температуры CPU:</p><div class="language-" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>from(bucket: &quot;\${Bucket}&quot;)</span></span>
<span class="line"><span>    |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)</span></span>
<span class="line"><span>    |&gt; filter(fn: (r) =&gt; r[&quot;_measurement&quot;] == &quot;sensors&quot;)</span></span>
<span class="line"><span>    |&gt; filter(fn: (r) =&gt; r[&quot;chip&quot;] == &quot;coretemp-isa-0000&quot;)</span></span>
<span class="line"><span>    |&gt; filter(fn: (r) =&gt; r[&quot;_field&quot;] == &quot;temp_input&quot;)</span></span>
<span class="line"><span>    |&gt; filter(fn: (r) =&gt; r[&quot;host&quot;] == &quot;\${server}&quot;)</span></span>
<span class="line"><span>    |&gt; aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)</span></span>
<span class="line"><span>    |&gt; yield(name: &quot;mean&quot;)</span></span></code></pre></div>`,79))])}const y=l(g,[["render",o]]),u=JSON.parse('{"path":"/docs/proxmox/rasshirennyy-monitoring-proxmox-s-pomoschyu-telegraf-i-influxdb.html","title":"Расширенный мониторинг Proxmox с помощью Telegraf и InfluxDB","lang":"ru-RU","frontmatter":{"title":"Расширенный мониторинг Proxmox с помощью Telegraf и InfluxDB","shortTitle":"Мониторинг Proxmox","icon":"carbon:cloud-monitoring","date":"2022-05-11T00:00:00.000Z","category":["Proxmox"],"tag":["grafana","influxDB","telegraf"],"description":"Архитектура решения: InfluxDB для хранения данных Telegraf как агент сбора метрик Grafana для визуализации и анализа Установка InfluxDB Создаем контейнер и ставим туда InfluxDB ...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Расширенный мониторинг Proxmox с помощью Telegraf и InfluxDB\\",\\"image\\":[\\"https://klimov.su/img/docs/proxmox-grafana-influxdb.png\\",\\"https://klimov.su/img/docs/proxmox-grafana-panels.png\\"],\\"datePublished\\":\\"2022-05-11T00:00:00.000Z\\",\\"dateModified\\":\\"2025-07-02T11:16:22.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://klimov.su/docs/proxmox/rasshirennyy-monitoring-proxmox-s-pomoschyu-telegraf-i-influxdb.html"}],["meta",{"property":"og:site_name","content":"Дмитрий Климов"}],["meta",{"property":"og:title","content":"Расширенный мониторинг Proxmox с помощью Telegraf и InfluxDB"}],["meta",{"property":"og:description","content":"Архитектура решения: InfluxDB для хранения данных Telegraf как агент сбора метрик Grafana для визуализации и анализа Установка InfluxDB Создаем контейнер и ставим туда InfluxDB ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://klimov.su/img/docs/proxmox-grafana-influxdb.png"}],["meta",{"property":"og:locale","content":"ru-RU"}],["meta",{"property":"og:updated_time","content":"2025-07-02T11:16:22.000Z"}],["meta",{"property":"article:tag","content":"telegraf"}],["meta",{"property":"article:tag","content":"influxDB"}],["meta",{"property":"article:tag","content":"grafana"}],["meta",{"property":"article:published_time","content":"2022-05-11T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-07-02T11:16:22.000Z"}]]},"git":{"createdTime":1751454982000,"updatedTime":1751454982000,"contributors":[{"name":"Godparent","username":"Godparent","email":"dmitriy@klimov.su","commits":1,"url":"https://github.com/Godparent"}]},"readingTime":{"minutes":3.16,"words":949},"filePathRelative":"docs/proxmox/rasshirennyy-monitoring-proxmox-s-pomoschyu-telegraf-i-influxdb.md","excerpt":"<p><strong>Архитектура решения</strong>:</p>\\n<ul>\\n<li><strong>InfluxDB</strong> для хранения данных</li>\\n<li><strong>Telegraf</strong> как агент сбора метрик</li>\\n<li><strong>Grafana</strong> для визуализации и анализа</li>\\n</ul>\\n<h2>Установка InfluxDB</h2>\\n<p>Создаем контейнер и ставим туда InfluxDB</p>","autoDesc":true}');export{y as comp,u as data};
